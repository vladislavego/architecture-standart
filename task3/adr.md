### **Название задачи:**
MVP: Открытие депозитов онлайн (концептуальная архитектура)

### **Автор:**
Vladislav

### **Дата:**
2025-12-17

---

### **Функциональные требования**

|**№**|**Действующие лица или системы**|**Use Case**|**Описание**|
| :-: | :- | :- | :- |
| 1 | Клиент (новый), Сайт, Система кол-центра | Подача заявки на депозит с сайта | 1) Клиент открывает страницу депозитов на сайте и видит актуальные ставки. 2) Заполняет форму (ФИО, телефон). 3) Сайт создаёт лид/заявку в системе кол-центра. 4) Менеджер кол-центра видит заявку и связывается с клиентом. 5) Клиент приходит в отделение для идентификации. |
| 2 | Клиент (существующий), Интернет-банк, Сервис заявок на депозит, SMS-шлюз | Подача заявки на депозит из интернет-банка (с подтверждением по СМС) | 1) Клиент в интернет-банке открывает раздел депозитов. 2) Видит актуальные и персонализированные ставки. 3) Выбирает депозит, счёт списания и сумму. 4) Интернет-банк запрашивает подтверждение в сервисе заявок. 5) Сервис инициирует отправку СМС. 6) Клиент вводит код в интернет-банке. 7) Интернет-банк подтверждает код через сервис заявок. 8) Заявка фиксируется со статусом «Принята». |
| 3 | Менеджер бэк-офиса депозитов, АБС, Сервис заявок на депозит | Обработка заявки и подтверждение условий (MVP) | 1) Менеджер бэк-офиса обрабатывает заявку по существующему процессу (MVP). 2) Подтверждает условия/ставку в АБС. 3) Открывает депозит в АБС. 4) Факт подтверждения/открытия синхронизируется в сервис заявок (для статусов и уведомлений). |
| 4 | Сервис заявок на депозит, SMS-шлюз, Клиент | Уведомления клиенту | 1) После подтверждения ставки отправляется СМС «Ставка подтверждена». 2) После открытия депозита отправляется СМС «Депозит открыт». 3) Уведомления записываются в журнал отправки (идемпотентность/ретраи). |

---

### **Нефункциональные требования**

|**№**|**Требование**|
| :-: | :- |
| 1 | Доступность онлайн-компонентов процесса: целевое SLA не ниже 99,9%, работа 24/7 |
| 2 | Минимизировать прямую нагрузку на АБС (Oracle/PL-SQL), т.к. БД перегружена и масштабируется вертикально |
| 3 | Безопасность: шифрование трафика (TLS) для сайта и интернет-банка; защита чувствительных данных; аудит операций |
| 4 | Производительность: отклик интерфейса «в миллисекундах»; устранить текущую проблему с >1 сек на справочниках (кеширование/оптимизация) |
| 5 | Отказоустойчивость: поддержка переключения ЦОД для интернет-банка; корректная деградация при сбоях внешних компонентов (SMS, интеграции) |
| 6 | Сопровождаемость: наблюдаемость (логи/метрики/трейсы), документация, контрактность интеграций |
| 7 | Ограничения технологий: максимально использовать существующий стек банка; учитывать, что текущая платформа интернет-банка несовместима с Kafka |
| 8 | Минимизировать зависимость от доработок «ядра» интернет-банка и подрядчиков (реализовать функционал силами команды банка) |

---

### **Решение**

#### Общее описание
Для MVP вводится выделенный компонент **«Сервис заявок на депозит (Deposit Applications Service)»**, который:
- является единой точкой приёма заявок из интернет-банка (и потенциально из сайта на следующих этапах),
- реализует подтверждение по СМС без доработок «ядра» интернет-банка,
- хранит статусы заявок и обеспечивает идемпотентность/ретраи уведомлений,
- изолирует АБС от прямого онлайн-трафика.

Для обработки MVP менеджер бэк-офиса продолжает работать в АБС, но заявка и статусы синхронизируются через **адаптер интеграции АБС** (изменения на стороне команды АБС, которая внутри банка).

#### Диаграмма контекста (C4 Context)
Файл диаграммы: `c4-context-deposits-mvp.puml` (экспортировать в PNG и положить рядом).

Ключевые взаимодействия:
- Клиент использует **Сайт** (маркетинг) и/или **Интернет-банк** (авторизованный канал).
- **Интернет-банк** обращается к **Сервису заявок на депозит** по HTTPS.
- **Сервис заявок** отправляет СМС через **SMS-шлюз** телеком-оператора.
- **АБС** используется бэк-офисом для подтверждения ставки и открытия депозита.
- **Адаптер интеграции АБС** синхронизирует статусы между АБС и сервисом заявок (MVP).

#### Диаграмма контейнеров (C4 Container)
Файл диаграммы: `c4-container-deposits-mvp.puml` (экспортировать в PNG и положить рядом).

Детализация интернет-банка:
- Web UI (ASP.NET MVC 4.5) — экраны депозитов, ввод суммы/счёта, ввод SMS-кода.
- Backend (монолит) — вызовы API сервиса заявок по HTTPS, получение ставок/статусов.

Детализация АБС:
- Desktop Client (Delphi) — рабочее место сотрудников фронт/бэк-офиса.
- Oracle DB + PL/SQL — доменная логика и учёт.
- Integration Job/Adapter (в контуре АБС) — безопасная интеграция наружу/внутрь без прямого онлайн-доступа к АБС из интернет-банка.

#### Логика выбора решений и технологий
- **Нагрузка на АБС**: вместо прямых синхронных вызовов из интернет-банка в АБС вводится промежуточный слой (сервис заявок), а синхронизация с АБС выполняется управляемо (со стороны команды АБС).
- **Минимизация зависимости от подрядчика интернет-банка**: подтверждение по СМС и статусная модель реализуются в сервисе заявок; интернет-банк добавляет только UI + вызовы внешнего API.
- **Совместимость со стеком**: сервис заявок реализуется на стеке, уже присутствующем в банке (Java/Spring Boot возможен по экспертизе кол-центра; хранилище — совместимое с существующей эксплуатацией). Kafka как обязательная зависимость в MVP не используется из-за несовместимости платформы интернет-банка.
- **Расширяемость**: сервис заявок и модель статусов позволяют перейти от MVP (ручная обработка) к автоматизации (годовой горизонт) без смены внешних контрактов.

---

### **Альтернативы**

1) Прямая интеграция интернет-банка с АБС (синхронно)
- Плюсы: быстрее в реализации «в лоб», меньше новых компонентов.
- Минусы: высокий риск по производительности/доступности из-за перегруженной БД АБС; сильная связанность; усложняет будущую эволюцию.

2) Реализация всей логики депозитов внутри интернет-банка (монолит)
- Плюсы: меньше интеграций.
- Минусы: зависимость от ядра платформы подрядчика; сложнее масштабировать и отделить ответственность; риск затрагивания существующих функций.

3) Event-driven интеграция через Kafka в MVP
- Плюсы: хорошая основа для масштабирования и декуплинга.
- Минусы: текущая платформа интернет-банка несовместима с Kafka; в MVP добавляет технологический риск и сроки.

---

**Недостатки, ограничения, риски**

1) Риск увеличения числа компонентов (новый сервис заявок + адаптер интеграции)
- Митигирование: минимальный набор функций в MVP, хорошая наблюдаемость, контрактность.

2) Риск рассинхронизации статусов между АБС и сервисом заявок
- Митигирование: идемпотентные операции, периодическая сверка, журнал событий/изменений статуса.

3) Риск по СМС (задержки/недоставка)
- Митигирование: ретраи, таймауты, лимиты, журнал отправки, понятный UX при ошибках.

4) Ограничения по инфраструктуре интернет-банка (один ЦОД, резервный ЦОД с переключением)
- Митигирование: предусмотреть работу сервиса заявок в том же профиле отказоустойчивости, формализовать требования к переключению.

5) Ограничение MVP: ручная обработка заявок
- Митигирование: статусная модель и контракты закладываются так, чтобы в следующей фазе заменить ручные шаги автоматизацией без ломки интерфейсов.